<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>è¡°å¼±ä¸­</title>
<style>
  :root { --primary: #ff6b6b; --bg: #fdfdfd; --text: #444; }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
    background: var(--bg); color: var(--text);
    margin: 0; padding: 0;
    height: 100vh; width: 100vw;
    overflow: hidden;
    display: flex; flex-direction: column;
  }
  
  /* æ“ä½œè¦ç´ ã®æ–‡å­—é¸æŠç¦æ­¢ */
  .btn, .home-btn, .card, #game-header, h1, .ver, #next-screen-hint {
    user-select: none; -webkit-user-select: none;
  }
  
  /* å…¥åŠ›æ¬„ã¨ãƒœã‚¿ãƒ³ã¯å¼·åˆ¶çš„ã«æ“ä½œå¯èƒ½ã«ã™ã‚‹ */
  input, textarea {
    user-select: text !important;
    -webkit-user-select: text !important;
    pointer-events: auto !important;
  }
  .btn, button {
    pointer-events: auto !important;
    cursor: pointer;
  }

  /* --- å…±é€šã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¨­å®š --- */
  .screen {
    display: none; width: 100%; height: 100%;
    flex-direction: column; align-items: center;
  }
  .screen.active { display: flex; }
  
  /* --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ --- */
  #start-screen { padding: 20px; overflow-y: auto; justify-content: flex-start; }
  h1 { color: var(--primary); font-size: 2rem; margin: 20px 0 10px; text-align: center; }
  .ver { color: #aaa; font-size: 0.8rem; margin-bottom: 20px; text-align: center; }
  
  .btn-container { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; margin: 0 auto; }
  .btn {
    background: var(--primary); color: white; border: none; padding: 15px;
    border-radius: 30px; font-weight: bold; font-size: 1.1rem;
    box-shadow: 0 4px 10px rgba(255,107,107,0.3);
    transition: transform 0.1s;
  }
  .btn:active { transform: scale(0.96); }
  .btn:disabled { background: #ddd; box-shadow: none; cursor: not-allowed; }
  
  #msg-area { min-height: 20px; margin-top: 20px; color: #888; font-size: 0.9rem; text-align: center; }
  
  /* --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
  #ranking-box {
    margin-top: 30px; margin-bottom: 50px;
    width: 95%; max-width: 400px; margin-left: auto; margin-right: auto;
  }
  .rank-section { margin-bottom: 25px; }
  .rank-header {
    font-weight: bold; color: var(--primary); margin-bottom: 5px;
    border-left: 4px solid var(--primary); padding-left: 8px; font-size: 1rem;
    display: flex; justify-content: space-between; align-items: center;
  }
  
  table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.85rem; }
  th { background: #f0f0f0; padding: 6px; text-align: left; color: #666; font-weight: normal; font-size: 0.8rem; }
  td { padding: 8px 6px; border-bottom: 1px solid #eee; }
  td.num { width: 40px; text-align: center; font-weight: bold; color: #888; }
  td.turn { text-align: right; font-weight: bold; color: var(--primary); width: 80px; }
  
  /* --- ã‚²ãƒ¼ãƒ ç”»é¢ --- */
  #game-header {
    width: 100%;
    min-height: 60px; /* ãƒãƒƒãƒå¯¾å¿œã®ãŸã‚å›ºå®šé«˜ã•å»ƒæ­¢ */
    
    background: rgba(255, 255, 255, 0.9);
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    justify-content: space-between;
    
    /* ãƒãƒƒãƒï¼ˆã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ï¼‰å¯¾å¿œ */
    padding-left: 20px;
    padding-right: 20px;
    padding-top: env(safe-area-inset-top, 20px); 
    padding-bottom: 10px;
    box-sizing: content-box;

    z-index: 10;
    position: relative;
  }
  .home-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; padding: 5px; }
  .turn-badge { background: #eee; padding: 6px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; color: #555; }

  #next-screen-hint {
    position: absolute; top: 70px; left: 0; width: 100%;
    text-align: center; color: var(--primary); font-weight: bold;
    font-size: 1.2rem;
    text-shadow: 0 0 5px rgba(255,255,255,0.9);
    pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 100;
  }
  #next-screen-hint.show { opacity: 1; animation: blink 2s infinite; }
  @keyframes blink { 50% { opacity: 0.6; } }

  #game-board-area {
    flex: 1; width: 100%;
    display: flex; align-items: center; justify-content: center;
    padding: 10px;
    overflow: hidden;
  }
  
  #game-board {
    display: grid;
    gap: 4px;
    justify-content: center; 
    align-content: center;
  }
  
  #center-title-box {
    grid-column: 1 / -1;
    display: flex; align-items: center; justify-content: center;
    text-align: center;
    height: 60px;
    margin: 4px 0;
    font-size: 1.2rem; font-weight: bold; color: #555;
    background: rgba(255,255,255,0.6);
    border-radius: 10px;
    transition: all 0.3s;
    user-select: none; -webkit-user-select: none;
  }
  #center-title-box.match-anim {
    color: #eebb00; transform: scale(1.1); text-shadow: 0 0 10px rgba(238, 187, 0, 0.5);
  }
  #center-title-box.congrats {
    background: rgba(255, 215, 0, 0.9); color: #fff;
    border: 2px solid #fff; box-shadow: 0 0 15px #ffd700;
    font-size: 1.5rem; transform: scale(1.05); z-index: 50;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }

  .card {
    position: relative; width: var(--card-size, 60px); height: var(--card-size, 60px);
    transform-style: preserve-3d; transition: transform 0.3s; cursor: pointer;
  }
  .card.flipped { transform: rotateY(180deg); }
  
  .face {
    position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
    border-radius: 6px; display: flex; justify-content: center; align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  }
  .front { background: var(--primary); color: white; border: 2px solid white; font-size: 1.2rem; }
  .front::after { content: "â˜…"; }
  .back { background: white; transform: rotateY(180deg); border: 2px solid var(--primary); }
  .back img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
  
  .card.matched-effect { animation: pop 0.4s ease-out; }
  @keyframes pop { 50% { transform: rotateY(180deg) scale(1.15); } }
  
  .mini-yay {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-size: 2rem; color: #ffd700; font-weight: bold;
    text-shadow: 0 2px 5px rgba(0,0,0,0.3); pointer-events: none;
    z-index: 100; animation: floatUp 1s ease-out forwards;
  }
  @keyframes floatUp {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
    100% { opacity: 0; transform: translate(-50%, -150%); }
  }

  /* --- ã‚¯ãƒªã‚¢ç”»é¢ --- */
  #clear-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: transparent;
    z-index: 2000; flex-direction: column; align-items: center; justify-content: center;
    transition: background 0.5s;
    pointer-events: none;
  }
  #clear-overlay.active { display: flex; }
  #clear-overlay.modal-mode { background: rgba(0,0,0,0.8); pointer-events: auto; }
  
  #submit-box {
    background: white; padding: 25px; border-radius: 15px; text-align: center;
    width: 85%; max-width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    opacity: 0; transform: translateY(20px); transition: all 0.5s;
    display: none;
  }
  #submit-box.show { opacity: 1; transform: translateY(0); display: block; }
  
  .confetti { position: fixed; width: 40px; height: 40px; z-index: 1500; pointer-events: none; }
</style>
</head>
<body>

<div id="start-screen" class="screen active">
  <h1>è¡°å¼±ä¸­</h1>
  <div class="ver">Ver 1.0</div>
  
  <div class="btn-container">
    <button id="btn-beg" class="btn" onclick="startGame('beg')" disabled>åˆç´š (10ãƒšã‚¢)</button>
    <button id="btn-int" class="btn" onclick="startGame('int')" disabled>ä¸­ç´š (30ãƒšã‚¢)</button>
    <button id="btn-adv" class="btn" onclick="startGame('adv')" disabled>ä¸Šç´š (å…¨ãƒšã‚¢)</button>
    </div>
  
  <div id="msg-area">èª­ã¿è¾¼ã¿ä¸­...</div>
  
  <div id="ranking-box">
    <div style="text-align:center; color:#888; margin-bottom:15px; font-weight:bold;">ğŸ† Ranking</div>
    <div id="ranking-list">Loading...</div>
  </div>
</div>

<div id="game-screen" class="screen">
  <div id="game-header">
    <button class="home-btn" onclick="confirmHome()">ğŸ </button>
    <span class="turn-badge" id="turn-display">Turn: 0</span>
  </div>
  
  <div id="next-screen-hint">ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ¬¡ã¸</div>
  
  <div id="game-board-area">
    <div id="game-board"></div>
  </div>
</div>

<div id="clear-overlay">
  <div id="submit-box">
    <h3 style="margin-top:0; color:var(--primary);">ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼</h3>
    <p id="result-detail">--ã‚¿ãƒ¼ãƒ³ã§ã‚¯ãƒªã‚¢</p>
    <p style="font-size:0.9rem;">è¨˜éŒ²ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ</p>
    <input type="text" id="player-name" placeholder="ãŠåå‰" onkeydown="if(event.key==='Enter') submitScore()" style="padding:10px; width:80%; margin-bottom:15px; border:1px solid #ddd; border-radius:5px; text-align:center;">
    <div style="display:flex; gap:10px;">
      <button type="button" class="btn" onclick="goHome()" style="flex:1; background:#ccc; font-size:0.9rem; padding:10px;">æˆ»ã‚‹</button>
      <button type="button" id="submit-btn" class="btn" onclick="submitScore()" style="flex:1; font-size:0.9rem; padding:10px;">é€ä¿¡</button>
    </div>
  </div>
</div>

<script>
// â–¼â–¼â–¼ ã“ã“ã«GASã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼â–¼â–¼
const API_URL = "https://script.google.com/macros/s/AKfycbxfSAhN7_lHGJ5c0YJknoJVJRVeX7oZrjVr0tm-ctp2JgQcfPTOo93awfznLIv_hT32AA/exec";
// â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

let allData = [];
let gameCards = [];
let flipped = [];
let turns = 0;
let matched = 0;
let level = '';
let isDemo = false;
let currentTitleText = "Start!";

window.onload = function() {
  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
  setTimeout(() => {
    if (document.getElementById('btn-beg').disabled) {
      document.getElementById('msg-area').innerText = "é€šä¿¡ãŒé…ã„ã‹ã€ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
      // ãƒ‡ãƒ¢ãƒœã‚¿ãƒ³è¡¨ç¤ºå‡¦ç†ã‚’å‰Šé™¤
    }
  }, 5000);

  // ãƒ‡ãƒ¼ã‚¿å–å¾— (fetch)
  fetch(API_URL + "?action=getCDData")
    .then(res => res.json())
    .then(data => {
      if (!data || data.length === 0) {
        document.getElementById('msg-area').innerText = "ãƒ‡ãƒ¼ã‚¿0ä»¶";
        // ãƒ‡ãƒ¢ãƒœã‚¿ãƒ³è¡¨ç¤ºå‡¦ç†ã‚’å‰Šé™¤
      } else {
        allData = data;
        document.getElementById('msg-area').innerText = `Loaded: ${data.length} songs`;
        document.getElementById('msg-area').style.color = 'var(--primary)';
        enableButtons();
      }
    })
    .catch(err => {
      document.getElementById('msg-area').innerText = "Load Err";
      console.error(err);
      // ãƒ‡ãƒ¢ãƒœã‚¿ãƒ³è¡¨ç¤ºå‡¦ç†ã‚’å‰Šé™¤
    });
    
  fetchRanking();
};

function enableButtons() {
  document.getElementById('btn-beg').disabled = false;
  document.getElementById('btn-int').disabled = false;
  document.getElementById('btn-adv').disabled = false;
}

// startDemoé–¢æ•°ã¯ä¸è¦ã§ã™ãŒã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã‚ˆã†æ®‹ã™ã‹å‰Šé™¤ã—ã¦ã‚‚OKï¼ˆå‘¼ã°ã‚Œãªã„ãŸã‚ï¼‰
// ã“ã“ã§ã¯å‰Šé™¤ã›ãšæ®‹ã—ã¦ãŠãã¾ã™ãŒã€ãƒœã‚¿ãƒ³ãŒãªã„ã®ã§å‘¼ã°ã‚Œã¾ã›ã‚“ã€‚

function fetchRanking() {
  fetch(API_URL + "?action=getRankings")
    .then(res => res.json())
    .then(data => showRanking(data))
    .catch(e => {
      document.getElementById('ranking-list').innerText = "Rank load error";
    });
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºé–¢æ•°
function showRanking(data) {
  const div = document.getElementById('ranking-list');
  
  if(!data || Object.keys(data).length === 0) { 
    div.innerHTML = "<small>No records</small>"; 
    return; 
  }
  
  const createTable = (list, title) => {
    let html = `<div class="rank-section"><div class="rank-header">${title}</div>`;
    
    if(!list || list.length === 0) {
      html += '<div style="padding:10px; font-size:0.8rem; color:#999; text-align:center;">è¨˜éŒ²ãªã—</div></div>';
      return html;
    }
    
    html += `<table>
      <thead>
        <tr>
          <th style="width:40px; text-align:center;">é †ä½</th>
          <th>åå‰</th>
          <th style="width:70px; text-align:right;">ã‚¿ãƒ¼ãƒ³æ•°</th>
        </tr>
      </thead>
      <tbody>`;
      
    list.forEach((r, i) => {
      let rankColor = i===0 ? '#ffd700' : (i===1 ? '#c0c0c0' : (i===2 ? '#b87333' : '#888'));
      
      html += `<tr>
        <td class="num" style="color:${rankColor}">${i+1}</td>
        <td>${escapeHtml(r.name)}</td>
        <td class="turn">${r.turns}</td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
    return html;
  };
  
  let finalHtml = "";
  finalHtml += createTable(data.beg, "åˆç´š (10ãƒšã‚¢)");
  finalHtml += createTable(data.int, "ä¸­ç´š (30ãƒšã‚¢)");
  finalHtml += createTable(data.adv, "ä¸Šç´š (å…¨ãƒšã‚¢)");
  
  div.innerHTML = finalHtml;
}

function escapeHtml(s) {
  return s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])) : '';
}

// ã€è¿½åŠ ã€‘åã‚Šãªãå®Œå…¨ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é–¢æ•°ï¼ˆãƒ•ã‚£ãƒƒã‚·ãƒ£ãƒ¼â€“ã‚¤ã‚§ãƒ¼ãƒ„æ³•ï¼‰
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}
  
function startGame(lv) {
  level = lv;
  turns = 0; matched = 0; flipped = [];
  currentTitleText = "Start!";
  
  document.getElementById('start-screen').classList.remove('active');
  document.getElementById('game-screen').classList.add('active');
  
  const overlay = document.getElementById('clear-overlay');
  overlay.classList.remove('active', 'modal-mode');
  overlay.style.pointerEvents = 'none'; 
  document.getElementById('submit-box').classList.remove('show');
  document.getElementById('next-screen-hint').classList.remove('show');
  
  const submitBtn = document.getElementById('submit-btn');
  submitBtn.disabled = false;
  submitBtn.innerText = 'é€ä¿¡';
  
  document.body.removeEventListener('click', onScreenClick);
  document.getElementById('turn-display').innerText = "Turn: 0";
  
  let count = lv=='beg' ? 10 : (lv=='int' ? 30 : allData.length);
  count = Math.min(count, allData.length);
  
  let deck = [];
  let shuffledData = shuffleArray([...allData]); 
  let useData = shuffledData.slice(0, count);

  useData.forEach(d => {
    let img1 = d.imgFirst;
    let img2 = d.imgRegular;
    if(!img2) img2 = 'https://placehold.co/100?text=NoImg';
    if(!img1) img1 = img2;
    deck.push({id: d.id, img: img1, title: d.title});
    deck.push({id: d.id, img: img2, title: d.title});
  });
  gameCards = shuffleArray(deck);
  
  renderBoard();
}

function renderBoard() {
  const boardArea = document.getElementById('game-board-area');
  const board = document.getElementById('game-board');
  
  const maxW = boardArea.clientWidth;
  const maxH = boardArea.clientHeight;
  const totalCards = gameCards.length;
  const half = Math.ceil(totalCards / 2);

  let cols = 4;
  if (level === 'beg') cols = 5;
  else if (level === 'int') cols = 6;
  else {
    let bestCols = 6;
    let bestSize = 0;
    for(let c=6; c<=14; c++) {
      const rowsPerHalf = Math.ceil(half / c);
      const gapW = (c - 1) * 4;
      const w = (maxW - gapW) / c;
      const h = (maxH - 80) / (rowsPerHalf * 2);
      const size = Math.floor(Math.min(w, h));
      if(size > bestSize) { bestSize = size; bestCols = c; }
    }
    cols = bestCols;
  }
  
  const rowsPerHalf = Math.ceil(half / cols);
  const gap = 4;
  const titleH = 60;
  
  const sizeW = (maxW - (cols - 1) * gap) / cols;
  const totalCardRows = rowsPerHalf * 2;
  const totalGapsH = (Math.max(0, rowsPerHalf - 1) * 2 + 2) * gap;
  const availableH = maxH - titleH - totalGapsH - 20;
  const sizeH = availableH / totalCardRows;
  
  let size = Math.floor(Math.min(sizeW, sizeH));
  if(size < 20) size = 20;
  
  document.documentElement.style.setProperty('--card-size', `${size}px`);
  board.style.gap = `${gap}px`;
  board.style.gridTemplateColumns = `repeat(${cols}, ${size}px)`;
  
  board.innerHTML = "";
  
  gameCards.forEach((c, i) => {
    if (i === half) {
      let titleBox = document.createElement('div');
      titleBox.id = 'center-title-box';
      titleBox.innerText = currentTitleText;
      board.appendChild(titleBox);
    }
    let d = document.createElement('div');
    d.className = 'card';
    d.onclick = () => flip(i, d, c);
    d.innerHTML = `<div class="face front"></div><div class="face back"><img src="${c.img}"></div>`;
    board.appendChild(d);
  });
}

function flip(i, el, card) {
  if(document.body.classList.contains('game-cleared')) return;
  if(flipped.length >= 2 || el.classList.contains('flipped')) return;
  
  currentTitleText = card.title;
  const titleBox = document.getElementById('center-title-box');
  if(titleBox) titleBox.innerText = currentTitleText;
  
  el.classList.add('flipped');
  flipped.push({el, id:card.id});
  
  if(flipped.length == 2) {
    turns++;
    document.getElementById('turn-display').innerText = `Turn: ${turns}`;
    let [c1, c2] = flipped;
    
    if(c1.id == c2.id) {
      matched++;
      flipped = [];
      if(titleBox) {
        titleBox.classList.add('match-anim');
        setTimeout(() => titleBox.classList.remove('match-anim'), 1000);
      }
      c1.el.classList.add('matched-effect');
      c2.el.classList.add('matched-effect');
      showMiniYay(c2.el);
      
      if(matched == gameCards.length/2) setTimeout(clearGame, 1000);
    } else {
      setTimeout(() => {
        c1.el.classList.remove('flipped');
        c2.el.classList.remove('flipped');
        flipped = [];
        currentTitleText = "...";
        if(document.getElementById('center-title-box')) {
          document.getElementById('center-title-box').innerText = "...";
        }
      }, 1000);
    }
  }
}

function showMiniYay(el) {
  const rect = el.getBoundingClientRect();
  const yay = document.createElement('div');
  yay.className = 'mini-yay';
  yay.innerText = "â™ª"; 
  document.body.appendChild(yay);
  yay.style.left = (rect.left + rect.width/2) + 'px';
  yay.style.top = (rect.top + rect.height/2) + 'px';
  setTimeout(() => yay.remove(), 1000);
}

function clearGame() {
  document.body.classList.add('game-cleared');
  const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3'];
  for(let i=0; i<60; i++) {
    let p = document.createElement('div');
    p.className = 'confetti';
    p.style.backgroundColor = colors[i%colors.length];
    p.style.left = Math.random()*100+'vw';
    p.style.top = -50 + 'px';
    p.style.width = (10+Math.random()*10)+'px';
    p.style.height = (5+Math.random()*10)+'px';
    p.style.animation = `fall ${2+Math.random()*3}s linear forwards`;
    p.style.transform = `rotate(${Math.random()*360}deg)`;
    document.body.appendChild(p);
  }
  const titleBox = document.getElementById('center-title-box');
  if(titleBox) {
    titleBox.innerText = "Congratulations!!";
    titleBox.classList.add('congrats');
  }
  const hint = document.getElementById('next-screen-hint');
  hint.classList.add('show');
  
  setTimeout(() => {
    document.body.addEventListener('click', onScreenClick, {once:true});
  }, 1000);
}

function onScreenClick(e) {
  document.getElementById('next-screen-hint').classList.remove('show');
  const overlay = document.getElementById('clear-overlay');
  overlay.classList.add('active');
  setTimeout(() => {
    overlay.classList.add('modal-mode');
    document.getElementById('result-detail').innerText = `${turns}ã‚¿ãƒ¼ãƒ³ã§ã‚¯ãƒªã‚¢ï¼`;
    document.getElementById('submit-box').classList.add('show');
    setTimeout(() => document.getElementById('player-name').focus(), 100);
  }, 100);
}

function submitScore() {
  const nameInput = document.getElementById('player-name');
  const name = nameInput.value.trim();
  const submitBtn = document.getElementById('submit-btn');

  if(!name) { 
    alert("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); 
    nameInput.focus();
    return; 
  }
  
  if(isDemo) {
    alert("ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ãªã®ã§é€ä¿¡ã—ã¾ã›ã‚“ã§ã—ãŸ");
    goHome();
    return;
  }

  submitBtn.disabled = true;
  submitBtn.innerText = "é€ä¿¡ä¸­...";
  nameInput.disabled = true;

  const params = `?action=saveRecord&name=${encodeURIComponent(name)}&level=${level}&turns=${turns}`;
  
  fetch(API_URL + params)
    .then(res => res.json())
    .then(data => {
      if (data.message === "Success") {
        alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼");
        goHome();
      } else {
        alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + data.message);
        resetSubmitBtn();
      }
    })
    .catch(err => {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err);
      resetSubmitBtn();
    });

  function resetSubmitBtn() {
    submitBtn.disabled = false;
    submitBtn.innerText = "é€ä¿¡";
    nameInput.disabled = false;
  }
}

function confirmHome() {
  if(confirm("ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿãƒ—ãƒ¬ã‚¤ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚")) {
    goHome();
  }
}

function goHome() {
  document.body.classList.remove('game-cleared');
  document.getElementById('game-screen').classList.remove('active');
  document.getElementById('clear-overlay').classList.remove('active', 'modal-mode');
  document.getElementById('start-screen').classList.add('active');
  document.querySelectorAll('.confetti').forEach(e => e.remove());
  const nameInput = document.getElementById('player-name');
  nameInput.value = '';
  nameInput.disabled = false;
  fetchRanking();
}

window.onresize = function() {
  if(gameCards.length > 0) renderBoard();
};
</script>
</body>
</html>
