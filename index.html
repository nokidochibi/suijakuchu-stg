<script>
// ▼▼▼ ここにGASのデプロイURLを貼り付けてください ▼▼▼
const API_URL = "https://script.google.com/macros/s/AKfycbxfSAhN7_lHGJ5c0YJknoJVJRVeX7oZrjVr0tm-ctp2JgQcfPTOo93awfznLIv_hT32AA/exec";
// ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

let allData = [];
let gameCards = [];
let flipped = [];
let turns = 0;
let matched = 0;
let level = '';
let currentTitleText = "Start!";

window.onload = function() {
  setTimeout(() => {
    if (document.getElementById('btn-beg').disabled) {
      document.getElementById('msg-area').innerText = "通信が遅いか、エラーの可能性があります。";
    }
  }, 5000);

  fetch(API_URL + "?action=getCDData")
    .then(res => res.json())
    .then(data => {
      if (!data || data.length === 0) {
        document.getElementById('msg-area').innerText = "データ0件";
      } else {
        allData = data;
        document.getElementById('msg-area').innerText = `Loaded: ${data.length} songs`;
        document.getElementById('msg-area').style.color = 'var(--primary)';
        enableButtons();
      }
    })
    .catch(err => {
      document.getElementById('msg-area').innerText = "Load Err";
      console.error(err);
    });
    
  fetchRanking();
};

function enableButtons() {
  document.getElementById('btn-beg').disabled = false;
  document.getElementById('btn-int').disabled = false;
  document.getElementById('btn-adv').disabled = false;
}

function fetchRanking() {
  fetch(API_URL + "?action=getRankings")
    .then(res => res.json())
    .then(data => showRanking(data))
    .catch(e => {
      document.getElementById('ranking-list').innerText = "Rank load error";
    });
}

function showRanking(data) {
  const div = document.getElementById('ranking-list');
  if(!data || Object.keys(data).length === 0) { 
    div.innerHTML = "<small>No records</small>"; 
    return; 
  }
  const createTable = (list, title) => {
    let html = `<div class="rank-section"><div class="rank-header">${title}</div>`;
    if(!list || list.length === 0) {
      html += '<div style="padding:10px; font-size:0.8rem; color:#999; text-align:center;">記録なし</div></div>';
      return html;
    }
    html += `<table><thead><tr><th style="width:40px; text-align:center;">順位</th><th>名前</th><th style="width:70px; text-align:right;">ターン数</th></tr></thead><tbody>`;
    list.forEach((r, i) => {
      let rankColor = i===0 ? '#ffd700' : (i===1 ? '#c0c0c0' : (i===2 ? '#b87333' : '#888'));
      html += `<tr><td class="num" style="color:${rankColor}">${i+1}</td><td>${escapeHtml(r.name)}</td><td class="turn">${r.turns}</td></tr>`;
    });
    html += '</tbody></table></div>';
    return html;
  };
  let finalHtml = "";
  finalHtml += createTable(data.beg, "初級 (10ペア)");
  finalHtml += createTable(data.int, "中級 (30ペア)");
  finalHtml += createTable(data.adv, "上級 (全ペア)");
  div.innerHTML = finalHtml;
}

function escapeHtml(s) {
  return s ? s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])) : '';
}

// 【重要】完全にランダムにシャッフルする関数
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function startGame(lv) {
  level = lv;
  turns = 0; matched = 0; flipped = [];
  currentTitleText = "Start!";
  
  document.getElementById('start-screen').classList.remove('active');
  document.getElementById('game-screen').classList.add('active');
  
  const overlay = document.getElementById('clear-overlay');
  overlay.classList.remove('active', 'modal-mode');
  overlay.style.pointerEvents = 'none'; 
  document.getElementById('submit-box').classList.remove('show');
  document.getElementById('next-screen-hint').classList.remove('show');
  
  const submitBtn = document.getElementById('submit-btn');
  submitBtn.disabled = false;
  submitBtn.innerText = '送信';
  
  document.body.removeEventListener('click', onScreenClick);
  document.getElementById('turn-display').innerText = "Turn: 0";
  
  let count = lv=='beg' ? 10 : (lv=='int' ? 30 : allData.length);
  count = Math.min(count, allData.length);
  
  let deck = [];
  
  // ▼▼▼ 修正箇所：確実にシャッフルしてからデータを使う ▼▼▼
  let shuffledData = shuffleArray([...allData]); 
  let useData = shuffledData.slice(0, count);
  // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

  useData.forEach(d => {
    let img1 = d.imgFirst;
    let img2 = d.imgRegular;
    if(!img2) img2 = 'https://placehold.co/100?text=NoImg';
    if(!img1) img1 = img2;
    deck.push({id: d.id, img: img1, title: d.title});
    deck.push({id: d.id, img: img2, title: d.title});
  });
  
  // カードの並び順も、この強いシャッフルで混ぜる
  gameCards = shuffleArray(deck);
  
  renderBoard();
}

function renderBoard() {
  const boardArea = document.getElementById('game-board-area');
  const board = document.getElementById('game-board');
  
  const maxW = boardArea.clientWidth;
  const maxH = boardArea.clientHeight;
  const totalCards = gameCards.length;
  const half = Math.ceil(totalCards / 2);

  let cols = 4;
  if (level === 'beg') cols = 5;
  else if (level === 'int') cols = 6;
  else {
    let bestCols = 6;
    let bestSize = 0;
    for(let c=6; c<=14; c++) {
      const rowsPerHalf = Math.ceil(half / c);
      const gapW = (c - 1) * 4;
      const w = (maxW - gapW) / c;
      const h = (maxH - 80) / (rowsPerHalf * 2);
      const size = Math.floor(Math.min(w, h));
      if(size > bestSize) { bestSize = size; bestCols = c; }
    }
    cols = bestCols;
  }
  
  const rowsPerHalf = Math.ceil(half / cols);
  const gap = 4;
  const titleH = 60;
  
  const sizeW = (maxW - (cols - 1) * gap) / cols;
  const totalCardRows = rowsPerHalf * 2;
  const totalGapsH = (Math.max(0, rowsPerHalf - 1) * 2 + 2) * gap;
  const availableH = maxH - titleH - totalGapsH - 20;
  const sizeH = availableH / totalCardRows;
  
  let size = Math.floor(Math.min(sizeW, sizeH));
  if(size < 20) size = 20;
  
  document.documentElement.style.setProperty('--card-size', `${size}px`);
  board.style.gap = `${gap}px`;
  board.style.gridTemplateColumns = `repeat(${cols}, ${size}px)`;
  
  board.innerHTML = "";
  
  gameCards.forEach((c, i) => {
    if (i === half) {
      let titleBox = document.createElement('div');
      titleBox.id = 'center-title-box';
      titleBox.innerText = currentTitleText;
      board.appendChild(titleBox);
    }
    let d = document.createElement('div');
    d.className = 'card';
    d.onclick = () => flip(i, d, c);
    d.innerHTML = `<div class="face front"></div><div class="face back"><img src="${c.img}"></div>`;
    board.appendChild(d);
  });
}

function flip(i, el, card) {
  if(document.body.classList.contains('game-cleared')) return;
  if(flipped.length >= 2 || el.classList.contains('flipped')) return;
  
  currentTitleText = card.title;
  const titleBox = document.getElementById('center-title-box');
  if(titleBox) titleBox.innerText = currentTitleText;
  
  el.classList.add('flipped');
  flipped.push({el, id:card.id});
  
  if(flipped.length == 2) {
    turns++;
    document.getElementById('turn-display').innerText = `Turn: ${turns}`;
    let [c1, c2] = flipped;
    
    if(c1.id == c2.id) {
      matched++;
      flipped = [];
      if(titleBox) {
        titleBox.classList.add('match-anim');
        setTimeout(() => titleBox.classList.remove('match-anim'), 1000);
      }
      c1.el.classList.add('matched-effect');
      c2.el.classList.add('matched-effect');
      showMiniYay(c2.el);
      
      if(matched == gameCards.length/2) setTimeout(clearGame, 1000);
    } else {
      setTimeout(() => {
        c1.el.classList.remove('flipped');
        c2.el.classList.remove('flipped');
        flipped = [];
        currentTitleText = "...";
        if(document.getElementById('center-title-box')) {
          document.getElementById('center-title-box').innerText = "...";
        }
      }, 1000);
    }
  }
}

function showMiniYay(el) {
  const rect = el.getBoundingClientRect();
  const yay = document.createElement('div');
  yay.className = 'mini-yay';
  yay.innerText = "♪"; 
  document.body.appendChild(yay);
  yay.style.left = (rect.left + rect.width/2) + 'px';
  yay.style.top = (rect.top + rect.height/2) + 'px';
  setTimeout(() => yay.remove(), 1000);
}

function clearGame() {
  document.body.classList.add('game-cleared');
  const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3'];
  for(let i=0; i<60; i++) {
    let p = document.createElement('div');
    p.className = 'confetti';
    p.style.backgroundColor = colors[i%colors.length];
    p.style.left = Math.random()*100+'vw';
    p.style.top = -50 + 'px';
    p.style.width = (10+Math.random()*10)+'px';
    p.style.height = (5+Math.random()*10)+'px';
    p.style.animation = `fall ${2+Math.random()*3}s linear forwards`;
    p.style.transform = `rotate(${Math.random()*360}deg)`;
    document.body.appendChild(p);
  }
  const titleBox = document.getElementById('center-title-box');
  if(titleBox) {
    titleBox.innerText = "Congratulations!!";
    titleBox.classList.add('congrats');
  }
  const hint = document.getElementById('next-screen-hint');
  hint.classList.add('show');
  
  setTimeout(() => {
    document.body.addEventListener('click', onScreenClick, {once:true});
  }, 1000);
}

function onScreenClick(e) {
  document.getElementById('next-screen-hint').classList.remove('show');
  const overlay = document.getElementById('clear-overlay');
  overlay.classList.add('active');
  setTimeout(() => {
    overlay.classList.add('modal-mode');
    document.getElementById('result-detail').innerText = `${turns}ターンでクリア！`;
    document.getElementById('submit-box').classList.add('show');
    setTimeout(() => document.getElementById('player-name').focus(), 100);
  }, 100);
}

function submitScore() {
  const nameInput = document.getElementById('player-name');
  const name = nameInput.value.trim();
  const submitBtn = document.getElementById('submit-btn');

  if(!name) { 
    alert("お名前を入力してください"); 
    nameInput.focus();
    return; 
  }
  
  submitBtn.disabled = true;
  submitBtn.innerText = "送信中...";
  nameInput.disabled = true;

  const params = `?action=saveRecord&name=${encodeURIComponent(name)}&level=${level}&turns=${turns}`;
  
  fetch(API_URL + params)
    .then(res => res.json())
    .then(data => {
      if (data.message === "Success") {
        alert("記録しました！");
        goHome();
      } else {
        alert("送信エラー: " + data.message);
        resetSubmitBtn();
      }
    })
    .catch(err => {
      alert("通信エラーが発生しました: " + err);
      resetSubmitBtn();
    });

  function resetSubmitBtn() {
    submitBtn.disabled = false;
    submitBtn.innerText = "送信";
    nameInput.disabled = false;
  }
}

function confirmHome() {
  if(confirm("ホームに戻りますか？プレイはリセットされます。")) {
    goHome();
  }
}

function goHome() {
  document.body.classList.remove('game-cleared');
  document.getElementById('game-screen').classList.remove('active');
  document.getElementById('clear-overlay').classList.remove('active', 'modal-mode');
  document.getElementById('start-screen').classList.add('active');
  document.querySelectorAll('.confetti').forEach(e => e.remove());
  const nameInput = document.getElementById('player-name');
  nameInput.value = '';
  nameInput.disabled = false;
  fetchRanking();
}

window.onresize = function() {
  if(gameCards.length > 0) renderBoard();
};
</script>
